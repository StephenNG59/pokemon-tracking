<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PokÃ©dex | PokÃ©mon Tracker</title>
  <!-- å­—ä½“ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <!-- å¼•å…¥Bootswatch: Mintyä¸»é¢˜ -->
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/minty/bootstrap.min.css" rel="stylesheet">
  <style>
    /* è‡ªå®šä¹‰å·¦è¾¹ä¾§è¾¹æ å’Œå¸ƒå±€æ ·å¼ */
    .pokedex-sidebar {
      height: calc(100vh - 60px);  /* éœ€è¦å»æ‰å¯¼èˆªæ çš„é«˜åº¦ 56px ä½¿å¾—æ»šåŠ¨æ¡æ­£å¸¸å·¥ä½œ */
      /* min-width: 360px; */
      width: 380px;
      overflow-y: scroll;  /* å‚ç›´æ»šåŠ¨ */
      border-right: 10px solid var(--bs-primary-bg-subtle);  /* æ·»åŠ åˆ†å‰²çº¿ */
      background-color: var(--bs-light);

      /* å°†æ»šåŠ¨æ¡æ”¾åˆ°å·¦ä¾§ */
      direction: rtl;
      text-align: left; /* ä¿æŒæ–‡æœ¬ä»å·¦åˆ°å³æ’åˆ— */
    }
    .pokedex-content {
      height: calc(100vh - 60px);  /* éœ€è¦å»æ‰å¯¼èˆªæ çš„é«˜åº¦ 56px ä½¿å¾—æ»šåŠ¨æ¡æ­£å¸¸å·¥ä½œ */
      width: calc(100vw - 380px);
      /* max-width: 80vw; */
      flex-grow: 1;  /* å æ»¡å‰©ä¸‹çš„å®½åº¦ */
      display: flex;  /* ä½¿å†…å®¹èƒ½å¤Ÿæ°´å¹³æˆ–å‚ç›´å¸ƒå±€ */
      flex-direction: column;  /* å‚ç›´æ’åˆ—å­å…ƒç´  */
      justify-content: left;  /* æ ¹æ®éœ€æ±‚è°ƒæ•´å¯¹é½æ–¹å¼ */
      padding: 20px;  /* é€‚å½“çš„å†…è¾¹è· */
      overflow-y: scroll;
      background-color: var(--bs-light-bg-subtle);
    }
    
    /* ================ è‡ªå®šä¹‰æ»šåŠ¨æ¡çš„æ ·å¼ ====================== */
    /* å·¦ä¾§ */
    /* åè½¬å†…éƒ¨æ»šåŠ¨æ¡æ–¹å‘ï¼Œä½¿æ»šåŠ¨æ¡åœ¨å·¦ä¾§ç”Ÿæ•ˆ */
    .pokedex-sidebar > * {
      direction: ltr; /* å†…éƒ¨å†…å®¹æ¢å¤ä¸ºå·¦åˆ°å³ */
    }
    .pokedex-sidebar::-webkit-scrollbar {
      width: 15px;  /* æ»šåŠ¨æ¡çš„å®½åº¦ */
    }
    .pokedex-sidebar::-webkit-scrollbar-track {
      background: var(--bs-primary-bg-subtle);  /* æ»šåŠ¨æ¡èƒŒæ™¯è‰² */
    }
    .pokedex-sidebar::-webkit-scrollbar-thumb {
      background-color: var(--bs-secondary-bg-subtle);  /* æ»šåŠ¨æ¡çš„é¢œè‰² */
      border-radius: 10px;  /* åœ†è§’æ»šåŠ¨æ¡ */
      border: 2px solid var(--bs-primary-bg-subtle);  /* æ»šåŠ¨æ¡çš„å¤–è¾¹æ¡† */
    }
    .pokedex-sidebar::-webkit-scrollbar-thumb:hover {
      background-color: var(--bs-secondary);  /* æ»šåŠ¨æ¡åœ¨ hover æ—¶å˜æš— */
    }
    /* å³ä¾§ */
    .pokedex-content::-webkit-scrollbar {
      width: 15px;  /* æ»šåŠ¨æ¡çš„å®½åº¦ */
    }
    .pokedex-content::-webkit-scrollbar-track {
      background: var(--bs-primary-bg-subtle);  /* æ»šåŠ¨æ¡èƒŒæ™¯è‰² */
    }
    .pokedex-content::-webkit-scrollbar-thumb {
      background-color: var(--bs-secondary-bg-subtle);  /* æ»šåŠ¨æ¡çš„é¢œè‰² */
      border-radius: 10px;  /* åœ†è§’æ»šåŠ¨æ¡ */
      border: 2px solid var(--bs-primary-bg-subtle);  /* æ»šåŠ¨æ¡çš„å¤–è¾¹æ¡† */
    }
    .pokedex-content::-webkit-scrollbar-thumb:hover {
      background-color: var(--bs-secondary);  /* æ»šåŠ¨æ¡åœ¨ hover æ—¶å˜æš— */
    }
    /* ================ è‡ªå®šä¹‰æ»šåŠ¨æ¡çš„æ ·å¼ ====================== */


    .pokedex-card {
      font-family: 'Poppins', sans-serif;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: auto;
      margin-bottom: 10px;
      border-radius: 10px;
      /* color: var(--bs-dark); */
      color: rgb(255, 255, 255);
    }
    .pokedex-card-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 10px;
      padding-left: 15px;
      flex-grow: 1;  /* è®©å·¦ä¾§ä¿¡æ¯åŒºåŸŸå æ®å‰©ä½™ç©ºé—´ */
    }
    .pokedex-card-thumbnail {
      background-color: rgba(255, 255, 255, 0.5);
      padding: 0px;
      border-top-left-radius: 50px;
      border-bottom-left-radius: 50px;
      border-top-right-radius: 12px;
      border-bottom-right-radius: 12px;
      display: flex;
      justify-content: flex-end;
      width: 95px;
      height: 80px;
    }
    .pokedex-card:hover {
      background-color: var(--bs-primary-bg-subtle);
    }
    .pokedex-card img {
      /* max-width: 60px; */
      height: 100%;  /* è®©å›¾ç‰‡å æ»¡å®¹å™¨ */
      width: auto;
      object-fit: contain;
    }
    .pokedex-card .progress-text {
      top: 50%;
      transform: translateY(-50%);
      color: var(--bs-dark);
    }
    .pokedex-card button {
      padding: 0;
      margin: 0;
      height: 24px;
      border-radius: 1.5rem;
      /* border-color: white; */
    }
    .pokedex-card button:hover {
      /* color: var(--bs-primary); */
      background-color: var(--bs-secondary);
      /* border-color: lightgreen; */
    }

    .pokedex-upper-row {
      display: flex;
      justify-content: space-between;
      width: 100%;
    }

    .pokedex-detail {
      font-family: 'Poppins', sans-serif;  /* è®¾ç½®æ•´ä½“å­—ä½“ */
      color: var(--bs-dark);
      height: 550px;
      min-width: 400px;
      width: 400px;
      /* display: flex; */
      /* flex-direction: column; */
      /* justify-content: start; */
      /* align-items: baseline; */
      padding: 10px;
      margin: 10px;
      border-radius: 10px;
      background-color: var(--bs-info-bg-subtle);
    }
    p, .badge {
      font-family: 'Poppins', sans-serif;
    }
    .pokedex-detail h2 {
      font-family: "Pacifico", cursive; /* Dancing Script */
      /* font-optical-sizing: auto; */
      font-weight: 400;
      font-style: normal;
    }
    .pokedex-detail h4 {
      font-weight: 500;
    }
    .pokedex-detail .progress {
      flex-grow: 1;
      height: 2rem;
      border-radius: 0.9rem;
    }
    .pokedex-detail .progress-text {
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      font-weight: 400;
    }
    #play-audio-btn {
      padding-top: 4px;
      padding-bottom: 4px;
      padding-left: 10px;
      padding-right: 10px;
    }
    .badge {
      font-size: 0.85rem;
      font-weight: 400;
    }

    .pokedex-image {
      height: 550px;
      max-width: 100%;
      flex-grow: 1; /* è‡ªåŠ¨å¡«å……æ•´ä¸ªå®½åº¦ */
      /* display: flex; */
      /* flex-direction: row; */
      /* justify-content: end; */
      padding: 10px;
      margin: 10px;
      border-radius: 10px;
      background-color: var(--bs-secondary-bg-subtle);
    }
    .pokedex-image-official-artwork {
      max-width: fit-content;
      /* height: 475px; */
      object-fit: contain;
    }
    .shiny-toggle-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      border: none;
      border-radius: 50%;
      padding: 10px;
      background: transparent;
      cursor: pointer;
    }
    .shiny-toggle-btn svg {
      width: 1.5em;
      height: 1.5em;
      stroke: #222222;
      fill: none;
    }

    .pokedex-media {
      /* min-height: 800px; */
      max-width: 100%;
      padding: 10px;
      margin: 10px;
      border-radius: 10px;
      background-color: var(--bs-primary-bg-subtle);
    }
    #pokedex-media-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      grid-gap: 20px;
    }
    #pokedex-media-container img {
      width: 100%;
      height: auto;
      border-radius: 10px;
      object-fit: cover;
      display: block;
    }
    #pokedex-media-container .media-card {
      width: 100%;
      height: 30vh;
      border-radius: 10px;
      display: block;
      border: 3px dashed var(--bs-primary-border-subtle);
    }


  </style>
</head>

<body>
<!-- =========================================================== -->
<!-- å¯¼èˆªæ  -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">PokÃ©mon Tracker</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarTracking" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Tracking
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarTracking">
            <li><a class="dropdown-item" href="/tracking/research">Research</a></li>
            <li><a class="dropdown-item" href="/tracking/habits">Habits</a></li>
            <li><a class="dropdown-item" href="/tracking/todos">To-Dos</a></li>
          </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/pokedex">PokÃ©dex</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Shops</a>
        </li>
      </ul>
    </div>

    <!-- æ˜¾ç¤ºé‡‘å¸å’Œæ—¶é—´ç²¾å -->
    <div>
      âœ¨
      <span id="coin-number" class="me-2"></span>
      âŒ›
      <span id="time-number" class="me-2"></span>
    </div>
  </div>
</nav>


<!-- =========================================================== -->
<!-- ä¸»å†…å®¹åŒºåŸŸ -->
<div class="container-fluid">
  <div class="row flex-nowrap">
    <!-- å·¦ä¾§æ»‘åŠ¨æ  -->
    <div class="pokedex-sidebar">
      <!-- <h5 class="text-center">PokÃ©dex</h5> -->
      <div id="pokedex-list" class="mt-4">
        <!-- åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½å®å¯æ¢¦ç¼©ç•¥å¡ç‰‡ -->
      </div>
    </div> 

    <!-- å³ä¾§å†…å®¹å±•ç¤º -->
    <div class="pokedex-content">
      <div class="pokedex-upper-row">
        <!-- ä¸Šé¢å·¦è¾¹è¯¦ç»†èµ„æ–™ -->
        <div class="pokedex-detail card p-3">
          <span>è¿™é‡Œæ˜¯è¯¦ç»†èµ„æ–™</span>
        </div>
  
        <!-- ä¸Šé¢å³è¾¹å›¾ç‰‡èµ„æ–™ -->
        <div class="pokedex-image card p-3">
          <span>è¿™é‡Œæ˜¯å¤§å›¾ç‰‡å±•ç¤ºåŒºåŸŸ</span>
          <!-- <img src="https://i.pinimg.com/originals/3c/a0/8b/3ca08beec594897f38f250e53d42aeb6.jpg"> -->
          <iframe src="https://assets.pinterest.com/ext/embed.html?id=57069120272813824"></iframe>
        </div>
      </div>

      <!-- ä¸‹é¢æ›´å¤šèµ„æ–™ -->
      <div class="pokedex-media card p-3">
        <div id="pokedex-media-container">
          <!-- åœ¨è¿™é‡Œå±•ç¤º Pinterest å›¾ç‰‡ -->
        </div>
        <button id="open-pinterest-btn" aria-label="Open Pinterest Button" class="btn btn-primary my-3">Open Pinterest</button>
      </div>
    </div>
  </div>
</div>


<!-- Bootswatch Minty JS & Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- å¼•å…¥ Color Thief ç”¨äºæå–å›¾ç‰‡é¢œè‰² -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
<script src="{{ url_for('static', filename='js/command.js') }}"></script>
<!-- å¼•å…¥ Masonry.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js"></script>

<script>
const commandManager = new CommandManager();
const colorThief = new ColorThief();
const unlockOfficialArtworkLevel = 10;
const unlockGifLevel = 20;
const unlockPinterestLevel = 30;
const unlockShinyArtworkLevel = 40;
const unlockEveryImgLevel = 10;  // æ¯10çº§ä¸€å¼ å›¾ç‰‡
let isShiny = false;

// ========================================================
// é¡µé¢åŠ è½½æ—¶
document.addEventListener('DOMContentLoaded', function () {
  const fetchPokedexCommand = new FetchPokedexCommand();
  const fetchItemsCommand = new FetchItemsCommand();
  commandManager.executeCommand(fetchPokedexCommand);
  commandManager.executeCommand(fetchItemsCommand);
});

// åœ¨ä¾§è¾¹æ ä¸­å±•ç¤ºå½“å‰å®å¯æ¢¦ç¼©ç•¥å¡ç‰‡
function displaySidebarCard(pokemon) {
  // åªæ˜¾ç¤ºå·²è§£é”çš„
  if (!pokemon.is_unlocked) { return; }

  const pokedexSidebar = document.getElementById('pokedex-list');
  if (!pokedexSidebar) { return; }

  const sidebarCard = document.createElement('div');
  // sidebarCard.classList.add('pokedex-card');

  const id = pokemon.id;
  const formattedId = String(id).padStart(3, '0');
  const url_id = pokemon.url_id;
  const imgSrc = `static/imgs/pokedex/thumbnail/${url_id}.png`;
  const isUnlocked = pokemon.is_unlocked;
  const nameCN = pokemon.name_cn;


  // 1. å¦‚æœè¿˜æœªè§£é”, æ˜¾ç¤ºç°è‰²å¤´åƒ, æ²¡æœ‰å…¶ä»–ä¿¡æ¯
  if (!isUnlocked) {
    sidebarCard.innerHTML = `
      <div class="pokedex-card" id="pokedex-card-${url_id}">
        <div class="pokedex-card-info">
          <strong>No.${formattedId}&nbsp&nbsp------</strong>
          <span>---- / ----</span>
        </div>
        <div class="pokedex-card-thumbnail">
          <img id="pokedex-thumbnail-${url_id}" src="${imgSrc}" alt="${nameCN}">
        </div>
      </div>
    `;
    pokedexSidebar.appendChild(sidebarCard);

    // è®¾ç½®å¡ç‰‡èƒŒæ™¯ä¸ºç°è‰², å®å¯æ¢¦ç¼©ç•¥å›¾ä¸ºç°è‰²å‰ªå½±
    const card = document.getElementById(`pokedex-card-${url_id}`);
    const thumbnailElement = document.getElementById(`pokedex-thumbnail-${url_id}`);
    card.style.backgroundColor = "var(--bs-gray)";
    // å¦‚æœåŠ ä¸Š invert(1) æˆ–è€…ç›´æ¥ brightness(1) å°±æ˜¯ç™½è‰²å‰ªå½±
    thumbnailElement.style.filter = 'brightness(0) invert(0.4)';

    return;
  }


  // 2. å¦‚æœè§£é”äº†, æ˜¾ç¤ºæ›´å¤šä¿¡æ¯, å¹¶æ³¨å†Œç‚¹å‡»äº‹ä»¶
  // å…³äºå½“å‰ç­‰çº§å’Œç»éªŒå€¼çš„è®¡ç®—
  const level = pokemon.level;
  const exp = pokemon.exp;
  const next_level_exp = Math.pow(level + 1, 3);
  const prev_level_exp = (level === 1) ? 0 : Math.pow(level, 3);
  const this_level_current_exp = Math.max(exp - prev_level_exp, 0);
  const this_level_max_exp = next_level_exp - prev_level_exp;
  const progress = (this_level_current_exp / this_level_max_exp) * 100;
  const learning_rate = pokemon.learning_rate;

  // ç±»å‹
  const type1 = pokemon.type1;
  const type2 = pokemon.type2;
  const type1_emoji = type1.match(/^[\p{Emoji_Presentation}\p{Extended_Pictographic}][\uFE0F]?/u)[0];
  const type2_emoji = type2 ? type2.match(/^[\p{Emoji_Presentation}\p{Extended_Pictographic}][\uFE0F]?/u)[0] : '';
  const typeContext = type1_emoji + (type2 ? '/' + type2_emoji : '');

  // ç¼©ç•¥å¡ç‰‡å†…å®¹
  sidebarCard.innerHTML = `
    <div class="pokedex-card" id="pokedex-card-${url_id}">
      <div class="pokedex-card-info">
        <!-- ç¼–å·åå­— -->
        <strong>No.${formattedId}&nbsp&nbsp${nameCN}</strong>
        <!-- ç±»å‹ç»éªŒ -->
        <div class="d-flex align-items-center justify-content-between" style="font-size: small;">
          <span style="width: 45px;">${typeContext}</span>
          <div class="progress position-relative" style="width: 130px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: ${progress}%; animation-duration: ${3. / Math.sqrt(learning_rate)}s;" aria-valuenow="${this_level_current_exp}" aria-valuemin="0" aria-valuemax="${this_level_max_exp}"></div>
            <span class="progress-text position-absolute w-100 text-center">Lv.${level}</span>
          </div>
          <button class="btn add-lr-100" url-id="${url_id}">>></button>
        </div>
      </div>
      <div class="pokedex-card-thumbnail">
        <img id="pokedex-thumbnail-${url_id}" src="${imgSrc}" alt="${nameCN}">
      </div>
    </div>
  `;
  pokedexSidebar.appendChild(sidebarCard);

  // å›¾ç‰‡åŠ è½½åæå–é¢œè‰²
  const thumbnailElement = document.getElementById(`pokedex-thumbnail-${url_id}`);
  
  // è®¾ç½®ç¼©ç•¥å¡ç‰‡é¢œè‰²ä¸ºå®å¯æ¢¦çš„ä¸»è‰²
  thumbnailElement.addEventListener('load', () => {
    if (thumbnailElement.complete && thumbnailElement.naturalHeight !== 0) {
      // æå–å›¾ç‰‡ä¸»é¢˜è‰²
      let color = colorThief.getColor(thumbnailElement);

      // è®¾ç½®å¡ç‰‡èƒŒæ™¯è‰²
      let colorCard = increaseSaturationLightness(color, 12, 6);
      const card = document.getElementById(`pokedex-card-${url_id}`);
      card.style.backgroundColor = `rgb(${colorCard[0]}, ${colorCard[1]}, ${colorCard[2]})`;

      // è®¾ç½®ç»éªŒæ¡é¢œè‰²
      const progressBar = card.querySelector('.progress-bar');
      progressBar.style.backgroundColor = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
    }
  });

  // å¦‚æœå·²è§£é”, ç‚¹å‡»å¯ä»¥æŸ¥çœ‹è¯¦æƒ…
  sidebarCard.addEventListener('click', () => {
    displayPokemon(id, url_id);
  });

  // åŠ é€Ÿå­¦ä¹ é€Ÿç‡çš„æŒ‰é’®(100ä¸ªæ—¶é—´ç²¾å -> å­¦ä¹ é€Ÿç‡ *= 2)
  const addLR100Btn = sidebarCard.querySelector('.add-lr-100');
  addLR100Btn.onclick = function() {
    const addLRCommand = new AddPokemonLearningRateCommand(id, url_id, 2);
    const addItemCommand = new AddItemCommand(11, -100);
    commandManager.executeCommand(addLRCommand);
    commandManager.executeCommand(addItemCommand);
  };
}

// å±•ç¤ºå®å¯æ¢¦è¯¦ç»†ä¿¡æ¯
function displayPokemon(id, url_id) {
  // æ‰“å¼€ IndexedDBï¼Œè·å–å®å¯æ¢¦çš„è¯¦ç»†ä¿¡æ¯
  openIndexedDB().then(db => {
    const transaction = db.transaction('Pokedex', 'readonly');
    const store = transaction.objectStore('Pokedex');
    
    // é€šè¿‡ url_id & id æŸ¥æ‰¾å®å¯æ¢¦
    const request = store.get([id, url_id]);
    
    request.onsuccess = (event) => {
      const pokemon = event.target.result;
      if (pokemon) {
        isShiny = false;

        const id = pokemon.id;
        const formattedId = String(id).padStart(3, '0');
        const name_cn = pokemon.name_cn;
        const name_en = pokemon.name_en;
        const level = pokemon.level;
        const exp = pokemon.exp;
        const type1 = pokemon.type1;
        const type2 = pokemon.type2;
        const height = pokemon.height / 10.0;
        const weight = pokemon.weight / 10.0;
        const flavor_text = pokemon.flavor_text;
        const unlocked_at = pokemon.unlocked_at;
        const img_urls = pokemon.img_urls;

        const hp = pokemon.hp;
        const atk = pokemon.attack;
        const def = pokemon.defense;
        const spatk = pokemon.special_attack;
        const spdef = pokemon.special_defense;
        const spd = pokemon.speed;

        const current_hp = calculatePokemonStat(hp, level, true);
        const current_atk = calculatePokemonStat(atk, level);
        const current_def = calculatePokemonStat(def, level);
        const current_spatk = calculatePokemonStat(spatk, level);
        const current_spdef = calculatePokemonStat(spdef, level);
        const current_spd = calculatePokemonStat(spd, level);

        // å…³äºå½“å‰ç­‰çº§å’Œç»éªŒå€¼çš„è®¡ç®—
        const next_level_exp = Math.pow(level + 1, 3);
        const prev_level_exp = (level === 1) ? 0 : Math.pow(level, 3);
        const this_level_current_exp = Math.max(exp - prev_level_exp, 0);
        const this_level_max_exp = next_level_exp - prev_level_exp;
        const progress = (this_level_current_exp / this_level_max_exp) * 100;
        const learning_rate = pokemon.learning_rate;

        // å…³äºè§£é”æ—¥æœŸè·ä»Šå¤©æ•°çš„è®¡ç®—
        const unlockedDate = new Date(unlocked_at);
        const today = new Date();
        const timeDifference = today - unlockedDate;
        const daysDifference = Math.floor(timeDifference / (1000 * 60 * 60 * 24));


        // æ›´æ–°è¯¦ç»†ä¿¡æ¯å¡ç‰‡
        // ============================================================
        const detailElement = document.querySelector(`.pokedex-detail`);
        detailElement.innerHTML = `
          <!-- åå­— (ä¸­è‹±æ–‡) -->
          <h2 class="mb-2">No.${formattedId}&nbsp;&nbsp;${name_en}</h2>
          
          <div class="d-flex align-items-center my-1" style="margin:3px;">
            <!-- ç­‰çº§å’Œç»éªŒå€¼è¿›åº¦æ¡ -->
            <h4 class="my-1">Lv.${level}</h4>
            <div class="progress position-relative ms-3 w-auto">
              <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: ${progress}%; animation-duration: ${3. / Math.sqrt(learning_rate)}s;" aria-valuenow="${this_level_current_exp}" aria-valuemin="0" aria-valuemax="${this_level_max_exp}"></div>
              <!-- æ·»åŠ ä¸€ä¸ªå®¹å™¨ç”¨äºæ˜¾ç¤ºæ–‡å­— -->
              <span class="progress-text position-absolute w-100 text-center" >${this_level_current_exp} / ${this_level_max_exp}</span>
            </div>

            <!-- å£°éŸ³æ’­æ”¾ -->
            <div class="audio-player my-1 ms-4">
              <button id="play-audio-btn" class="btn btn-primary">ğŸ±ğŸ“£</button>

              <!-- éšè—çš„éŸ³é¢‘å…ƒç´  -->
              <audio id="pokemon-audio" src="https://raw.githubusercontent.com/PokeAPI/cries/main/cries/pokemon/latest/${url_id}.ogg"></audio>
            </div>
          </div>

          <div class="my-1 d-flex justify-content-between">
            <!-- ç±»å‹å±•ç¤º -->
            <div>
              <span class="badge bg-primary">${type1}</span>
              ${type2 ? `<span class="badge bg-secondary ms-1">${type2}</span>` : ''}
            </div>
            <!-- é«˜åº¦å’Œé‡é‡ -->
            <div class="d-flex">
              <div class="me-3"><span class="me-1">ğŸ“</span>${height} m</div>
              <div class="me-3"><span class="me-1">âš–ï¸</span>${weight} kg</div>
            </div>
          </div>

          <!-- æè¿° -->
          <p class="my-1">${flavor_text}</p>

          <!-- å±æ€§å±•ç¤º -->
          <div class="row" style="display: flex; justify-content: center;">
            <div class="col-8">
              <canvas id="stats-radar-chart" width="250" height="250"></canvas>
            </div>
          </div>

          <!-- è§£é”æ—¥æœŸ -->
          <div class="mt-3">
            <small>Unlocked at: </small>
            <strong>${daysDifference}</strong>
            <small> days ago (${unlocked_at})</small>
          </div>
        `;

        // å±æ€§é›·è¾¾å›¾
        let infoRGB = getComputedStyle(document.documentElement).getPropertyValue('--bs-info-rgb').trim();
        let infoColor = `rgb(${infoRGB})`;
        let infoBgColor = `rgba(${infoRGB}, 0.2)`;
        let secRGB = getComputedStyle(document.documentElement).getPropertyValue('--bs-secondary-rgb').trim();
        let secColor = `rgb(${secRGB})`;
        let secBgColor = `rgba(${secRGB}, 0.2)`;

        const ctx = document.getElementById('stats-radar-chart').getContext('2d');
        const statsRadarChart = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: [
              [String(current_hp), 'â¤ï¸'], 
              'âš”ï¸ ' + String(current_atk), 
              'ğŸ›¡ï¸ ' + String(current_def), 
              ['ğŸŒ€', String(current_spd)], 
              String(current_spdef) + ' ğŸ”°',
              String(current_spatk) + ' ğŸ”®', 
            ],  // å…­ç»´æ•°æ®æ ‡ç­¾
            datasets: [
              {
                label: 'Current',
                data: [current_hp, current_atk, current_def, current_spd, current_spdef, current_spatk],  // å…­ç»´æ•°æ®å€¼
                backgroundColor: infoBgColor,  // å¡«å……é¢œè‰²
                borderColor: infoColor,  // è¾¹æ¡†é¢œè‰²
                borderWidth: 2,  // è¾¹æ¡†å®½åº¦
                pointBackgroundColor: infoColor,  // ç‚¹çš„é¢œè‰²
                pointBorderWidth: 0,  // ç‚¹çš„è¾¹æ¡†
                pointHoverBackgroundColor: '#fff',
              },
              {
                label: 'Species',
                data: [hp, atk, def, spd, spdef, spatk],
                backgroundColor: secBgColor,
                borderWidth: 0,
                pointRadius: 0,
                pointBorderWidth: 0,
              }
          ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false,  // éšè—å›¾ä¾‹
              },
            },
            scales: {
              r: {
                beginAtZero: true,
                ticks: {
                  display: false, // ä¸æ˜¾ç¤ºåˆ»åº¦
                  stepSize: 100,  // è‡ªå®šä¹‰æ¯ä¸ªåˆ»åº¦çš„æ•°å€¼å·®
                  // color: '#666',  // åˆ»åº¦é¢œè‰²
                },
                angleLines: {
                  color: '#ccc',  // åˆ†éš”çº¿é¢œè‰²
                },
                grid: {
                  color: '#ddd',  // ç½‘æ ¼çº¿é¢œè‰²
                },
                pointLabels: {
                  color: '#333',  // æ ‡ç­¾é¢œè‰²
                  font: {
                    size: 14,  // å­—ä½“å¤§å°
                  },
                  callback: function(value) {
                    return value;  // è¿”å›æ•°ç»„æ ¼å¼çš„æ ‡ç­¾(ä¸ºäº†åˆ†è¡Œæ˜¾ç¤º"HPâ¤ï¸")
                  }
                },
                suggestedMin: 0,
                suggestedMax: 200,
              }
            }
          }
        });

        // æ›´æ–°å›¾ç‰‡å±•ç¤ºå¡ç‰‡
        // ============================================================
        // å›¾ç‰‡èµ„æºåœ°å€
        const officialArtworkUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${url_id}.png`
        const officialArtworkShinyUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/shiny/${url_id}.png`
        const imageCardElement = document.querySelector(`.pokedex-image`);
        imageCardElement.innerHTML = `
          <img id="pokemon-official-artwork" class="pokedex-image-official-artwork" src="${officialArtworkUrl}" alt="${name_cn}" class="img-fluid">
          <button id="toggle-shiny-btn" aria-label="Shiny toggle Button" class="btn btn-secondary shiny-toggle-btn" >
            <svg stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
              <path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M259.92 262.91L216.4 149.77a9 9 0 00-16.8 0l-43.52 113.14a9 9 0 01-5.17 5.17L37.77 311.6a9 9 0 000 16.8l113.14 43.52a9 9 0 015.17 5.17l43.52 113.14a9 9 0 0016.8 0l43.52-113.14a9 9 0 015.17-5.17l113.14-43.52a9 9 0 000-16.8l-113.14-43.52a9 9 0 01-5.17-5.17zM108 68L88 16 68 68 16 88l52 20 20 52 20-52 52-20-52-20zm318.67 49.33L400 48l-26.67 69.33L304 144l69.33 26.67L400 240l26.67-69.33L496 144l-69.33-26.67z"></path>
            </svg>
          </button>
        `;

        // åˆ‡æ¢é—ªå…‰å›¾ç‰‡
        const pokemonOfficialArtwork = document.getElementById('pokemon-official-artwork');
        const toggleShinyBtn = document.getElementById('toggle-shiny-btn');
        toggleShinyBtn.onclick = function() {
          if (isShiny) {
            pokemonOfficialArtwork.src = officialArtworkUrl;
            toggleShinyBtn.querySelector('path').style.fill = 'none'; // useless
            // toggleShinyBtn.classList.remove('checked'); // useless
            isShiny = false;
          } else {
            pokemonOfficialArtwork.src = officialArtworkShinyUrl;
            toggleShinyBtn.querySelector('path').style.fill = '#222222'; // useless
            // toggleShinyBtn.classList.add('checked'); // useless
            isShiny = true;
          }
        };

        // å£°éŸ³æ’­æ”¾
        const audioElement = document.getElementById('pokemon-audio');
        const playAudioButton = document.getElementById('play-audio-btn');
        playAudioButton.onclick = function() {
          audioElement.currentTime = 0;  // é‡ç½®éŸ³é¢‘æ’­æ”¾è¿›åº¦
          audioElement.volume = 0.2;
          audioElement.play();  // æ’­æ”¾éŸ³é¢‘
        };

        // æ›´æ–°åª’ä½“å±•ç¤º
        displayMediaContainer(pokemon);

        // ä¸€äº›åŠŸèƒ½çš„é™åˆ¶æˆ–åˆ é™¤
        // ====================================================================
        // ç­‰çº§é™åˆ¶
        if (level < unlockOfficialArtworkLevel) {
          pokemonOfficialArtwork.style.filter = 'brightness(0) invert(0.9)';
          pokemonOfficialArtwork.setAttribute('title', `unlocked at Lv.${unlockOfficialArtworkLevel}`);
        }
        if (level < unlockShinyArtworkLevel) {
          toggleShinyBtn.style.filter = 'brightness(0) invert(0.9)';
          toggleShinyBtn.classList.add('disabled');
          toggleShinyBtn.setAttribute('title', `unlocked at Lv.${unlockShinyArtworkLevel}`);
        }
        
        // å¦‚æœä¸å­˜åœ¨é—ªå…‰å›¾ç‰‡, åˆ é™¤æŒ‰é’®
        fetch(officialArtworkShinyUrl, { method: 'HEAD' })
        .then(response => {
          if (response.ok) {
            // å¦‚æœé—ªå…‰å›¾ç‰‡å­˜åœ¨
          } else {
            // å¦‚æœé—ªå…‰å›¾ç‰‡ä¸å­˜åœ¨
            toggleShinyBtn.remove();
          }
        })
        .catch(error => {
          console.error('Error fetching shiny image:', error);
        });
      }
    };

    request.onerror = (event) => {
      console.error('Error fetching Pokemon details from IndexedDB:', event.target.error);
    };
  });
}

// æ›´æ–°åª’ä½“å±•ç¤º
function displayMediaContainer(pokemon) {
  const openPinterestBtn = document.getElementById('open-pinterest-btn');
  openPinterestBtn.onclick = function() {
    const searchUrl = `https://www.pinterest.com/search/pins/?q=pokemon%20${pokemon.name_en}%20wallpapers`;
    const height = window.screen.availHeight;
    const width = 660;
    window.open(searchUrl, '_blank', `width=${width},height=${height},scrollbars=yes,resizable=yes`);
  };

  const mediaContainer = document.getElementById('pokedex-media-container');
  mediaContainer.innerHTML = '';
  if (pokemon.img_urls) {
    pokemon.img_urls.forEach(url => {
      const imgCard = document.createElement('img');
      imgCard.src = url;
      mediaContainer.appendChild(imgCard);
    });
  } else {
    pokemon.img_urls = [];
  }

  // const grid = document.getElementById('pokedex-media-container');
  // const msnry = new Masonry(grid, {
  //     itemSelector: 'img',      // å›¾ç‰‡é€‰æ‹©å™¨
  //     columnWidth: 300,         // åˆ—å®½
  //     gutter: 20                // å›¾ç‰‡é—´è·
  // });
  
  createAddImgCard(pokemon);
}

// æ·»åŠ ä¸€ä¸ªæ‹–åŠ¨å¯ä»¥æ·»åŠ å›¾ç‰‡çš„æ¡†
function createAddImgCard(pokemon) {
  // ç‚¹å‡»å¯ä»¥æ·»åŠ å›¾ç‰‡çš„å¡ç‰‡(æ¯5çº§å¯ä»¥æ”¾ä¸€å¼ )
  if (Math.floor(pokemon.level / unlockEveryImgLevel) > pokemon.img_urls.length) {
    const addImgCard = document.createElement('div');
    addImgCard.className = "media-card";

    const mediaContainer = document.getElementById('pokedex-media-container');
    mediaContainer.appendChild(addImgCard);

    addImgCard.ondragover = function() {
      event.preventDefault();  // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œå…è®¸æ‹–åŠ¨
      addImgCard.style.borderColor = "var(--bs-primary)";
    };

    addImgCard.ondragleave = function() {
      addImgCard.style.borderColor = "var(--bs-primary-border-subtle)";
    };

    addImgCard.ondrop = function() {
      event.preventDefault();
      addImgCard.style.borderColor = "var(--bs-primary-border-subtle)";

      const draggedUrl = event.dataTransfer.getData('text/plain');
      if (draggedUrl) {
        // æ·»åŠ  Image
        addPokemonImgCommand = new AddPokemonImgCommand(pokemon.id, pokemon.url_id, draggedUrl);
        commandManager.executeCommand(addPokemonImgCommand);
        // é‡æ–°æ›´æ–°åª’ä½“å±•ç¤º
        displayMediaContainer(pokemon);
      }
    }
  }
}

// é€šè¿‡ç§æ—å€¼å’Œç­‰çº§è®¡ç®—å½“å‰æ•°å€¼
function calculatePokemonStat(base, level, isHP=false) {
  let current = Math.floor((2.2 * base + level / 2) * level / 100) + 5;
  if (isHP) {
    current += level + 5;
  }
  return current;
}

// å°†RGBè½¬æ¢ä¸ºHSLï¼Œå¢åŠ é¥±å’Œåº¦å’Œäº®åº¦
function increaseSaturationLightness(rgb, saturationIncrease = 10, lightnessIncrease = 10) {
  const [r, g, b] = rgb.map(x => x / 255);
  const max = Math.max(r, g, b), min = Math.min(r, g, b);
  let h, s, l = (max + min) / 2;

  if (max === min) {
    h = s = 0; // achromatic
  } else {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

    switch (max) {
      case r: h = (g - b) / d + (g < b ? 6 : 0); break;
      case g: h = (b - r) / d + 2; break;
      case b: h = (r - g) / d + 4; break;
    }

    h /= 6;
  }

  // å¢åŠ é¥±å’Œåº¦
  s = Math.max(0, Math.min(1, s + saturationIncrease / 100));

  // å¢åŠ äº®åº¦
  l = Math.max(0, Math.min(1, l + lightnessIncrease / 100));

  // è½¬å›åˆ°RGB
  const hue2rgb = (p, q, t) => {
    if (t < 0) t += 1;
    if (t > 1) t -= 1;
    if (t < 1 / 6) return p + (q - p) * 6 * t;
    if (t < 1 / 2) return q;
    if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
    return p;
  };

  let q = l < 0.5 ? l * (1 + s) : l + s - l * s;
  let p = 2 * l - q;

  let rNew = hue2rgb(p, q, h + 1 / 3);
  let gNew = hue2rgb(p, q, h);
  let bNew = hue2rgb(p, q, h - 1 / 3);

  return [Math.round(rNew * 255), Math.round(gNew * 255), Math.round(bNew * 255)];
}


</script>
</body>
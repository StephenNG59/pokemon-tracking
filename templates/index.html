<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokÃ©mon Tracker</title>
    <!-- å¼•å…¥Bootswatch: Darklyä¸»é¢˜ -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/darkly/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<!-- å¯¼èˆªæ  -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">PokÃ©mon Tracker</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarTracking" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Tracking
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarTracking">
            <li><a class="dropdown-item" href="#">Research</a></li>
            <li><a class="dropdown-item" href="#">Habits</a></li>
            <li><a class="dropdown-item" href="#">To-Dos</a></li>
          </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">PokÃ©dex</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Shops</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- ä¸»å†…å®¹åŒºåŸŸ -->
<div class="container mt-4">
  <h2 class="mb-4">To-Dos</h2>
  
  <!-- ä»»åŠ¡è¾“å…¥æ¡† -->
  <form id="todo-form" class="mb-3">
    <div class="input-group d-flex align-items-center">
      <input type="text" class="form-control" id="task-title" placeholder="Task title...">
      <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#task-details" aria-expanded="false" aria-controls="task-details">
        Toggle Details
      </button>
      <button class="btn btn-success" type="button" id="add-task">Add Task</button>
    </div>
  </form>

  <!-- å¯å±•å¼€çš„å†…å®¹ï¼šNotes, Importance, Difficulty, Estimated Time -->
  <div class="collapse" id="task-details">
    <div class="card card-body">
      <form>
        <!-- Notes -->
        <div class="mb-3">
          <label for="task-notes" class="form-label">Notes</label>
          <textarea class="form-control" id="task-notes" rows="2" placeholder="ä»»åŠ¡å¤‡æ³¨"></textarea>
        </div>

        <!-- Emergency é€‰æ‹© -->
        <label style="width: 120px" class="me-2">Emergency</label>
        <div class="btn-group" role="group" aria-label="Emergency group">
          <input type="radio" class="btn-check" name="task-emergency" id="emergency-low" autocomplete="off" checked="" value=1>
          <label class="btn btn-outline-danger" for="emergency-low" style="width: 80px;">Low</label>

          <input type="radio" class="btn-check" name="task-emergency" id="emergency-medium" autocomplete="off" value=2>
          <label class="btn btn-outline-danger" for="emergency-medium" style="width: 100px;">Medium</label>

          <input type="radio" class="btn-check" name="task-emergency" id="emergency-high" autocomplete="off" value=3>
          <label class="btn btn-outline-danger" for="emergency-high" style="width: 100px;">High</label>

          <input type="radio" class="btn-check" name="task-emergency" id="emergency-critical" autocomplete="off" value=4>
          <label class="btn btn-outline-danger" for="emergency-critical" style="width: 120px;">Critical</label>
        </div>
        <br>

        <!-- Importance é€‰æ‹© -->
        <label style="width: 120px" class="me-2">Importance</label>
        <div class="btn-group" role="group" aria-label="Importance group">
          <input type="radio" class="btn-check" name="task-importance" id="importance-low" autocomplete="off" checked="" value=1>
          <label class="btn btn-outline-warning" for="importance-low" style="width: 80px;">Low</label>

          <input type="radio" class="btn-check" name="task-importance" id="importance-medium" autocomplete="off" value=2>
          <label class="btn btn-outline-warning" for="importance-medium" style="width: 100px;">Medium</label>

          <input type="radio" class="btn-check" name="task-importance" id="importance-high" autocomplete="off" value=3>
          <label class="btn btn-outline-warning" for="importance-high" style="width: 100px;">High</label>

          <input type="radio" class="btn-check" name="task-importance" id="importance-critical" autocomplete="off" value=4>
          <label class="btn btn-outline-warning" for="importance-critical" style="width: 120px;">Critical</label>
        </div>
        <br>

        <!-- Difficulty é€‰æ‹© -->
        <label style="width: 120px" class="me-2">Difficulty</label>
        <div class="btn-group" role="group" aria-label="Difficulty group">
          <input type="radio" class="btn-check" name="task-difficulty" id="difficulty-easy" autocomplete="off" checked="" value=1>
          <label class="btn btn-outline-info" for="difficulty-easy" style="width: 80px;">Easy</label>

          <input type="radio" class="btn-check" name="task-difficulty" id="difficulty-medium" autocomplete="off" value=2>
          <label class="btn btn-outline-info" for="difficulty-medium" style="width: 100px;">Medium</label>

          <input type="radio" class="btn-check" name="task-difficulty" id="difficulty-hard" autocomplete="off" value=3>
          <label class="btn btn-outline-info" for="difficulty-hard" style="width: 100px;">Hard</label>

          <input type="radio" class="btn-check" name="task-difficulty" id="difficulty-very-hard" autocomplete="off" value=4>
          <label class="btn btn-outline-info" for="difficulty-very-hard" style="width: 120px;">Very Hard</label>
        </div>
        <br>

        <!-- Estimated Time (ä½¿ç”¨é€‰æ‹©æ¡†å®ç°) -->
        <div class="mb-3 d-flex align-items-center">
          <label for="task-time" class="form-label me-2" style="width: 120px">Estimated Time</label>
          <select class="form-select w-auto" id="task-time">
            <option value="15">15 åˆ†é’Ÿ</option>
            <option value="30">30 åˆ†é’Ÿ</option>
            <option value="60">1 å°æ—¶</option>
            <option value="90">1.5 å°æ—¶</option>
            <option value="120">2 å°æ—¶</option>
          </select>
        </div>
      </form>
    </div>
  </div>

  <!-- æ˜¾ç¤ºå·²æ·»åŠ çš„ä»»åŠ¡ -->
  <div class="accordion" id="task-list">
    <h4>Unfinished</h4>
    <ul class="list-group">
      <!-- åŠ¨æ€ä»»åŠ¡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
    </ul>
  </div>
</div>

<!-- å¼•å…¥Bootstrapçš„JSç»„ä»¶ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- JavaScripté€»è¾‘ï¼ˆç”¨äºæ·»åŠ ä»»åŠ¡ï¼‰ -->
<script>
// ä¿å­˜ä»»åŠ¡åˆ°æœåŠ¡å™¨
function saveTaskToServer(task) {
  fetch('/add_task', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(task),
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      task.id = data.id;  // è·å–ä»åç«¯è¿”å›çš„ä»»åŠ¡id
      displayTask(task);  // æ˜¾ç¤ºä»»åŠ¡
    }
  })
  .catch((error) => {
    console.error('Error:', error);
  });
}

// æ˜¾ç¤ºä»»åŠ¡å‡½æ•°
function displayTask(task) {
  const taskList = document.getElementById('task-list').querySelector('ul');
  const listItem = document.createElement('div');
  listItem.classList.add('accordion-item');

  // è·å–Emergency,Importance,Difficultyçš„ç¬¦å·è¡¨ç¤º
  const emergencySymbol = task.emergency === 1 ? 'â•' : 
                          task.emergency === 2 ? 'â•â•' : 
                          task.emergency === 3 ? 'â•â•â•' : 
                          task.emergency === 4 ? 'â•â•â•â•' :
                          task.emergency;
  const importanceSymbol = task.importance === 1 ? 'â­' :
                           task.importance === 2 ? 'â­â­' :
                           task.importance === 3 ? 'â­â­â­' : 
                           task.importance === 4 ? 'â­â­â­â­' : 
                           task.importance;
  const difficultySymbol = task.difficulty === 1 ? 'ğŸ—' :
                           task.difficulty === 2 ? 'ğŸ—ğŸ—' : 
                           task.difficulty === 3 ? 'ğŸ—ğŸ—ğŸ—' : 
                           task.difficulty === 4 ? 'ğŸ—ğŸ—ğŸ—ğŸ—' :
                           task.difficulty; 

  // æŠŠNotesä¸­çš„æ¢è¡Œç¬¦æ›¿æ¢ä¸ºHTMLçš„æ¢è¡Œæ ‡ç­¾
  const formattedNotes = task.notes.replace(/\n/g, '<br>');

  // ä»»åŠ¡æ˜¾ç¤º
  listItem.innerHTML = `
    <h2 class="accordion-header" id="heading-${task.id}">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${task.id}" aria-expanded="false" aria-controls="collapse-${task.title}">
        <span style="width: 200px; overflow: hidden; text-overflow: ellipsis;">${task.title}</span>
        <span style="width: 80px;">${emergencySymbol}</span>
        <span style="width: 150px;">${importanceSymbol}</span>
        <span style="width: 150px;">${difficultySymbol}</span>
        <span style="width: 80px;">${task.time}min</span>
      </button>
    </h2>
    <div id="collapse-${task.id}" class="accordion-collapse collapse" aria-labelledby="heading-${task.id}" data-bs-parent="#task-list">
      <div class="accordion-body">
        <p style="white-space: pre-wrap; word-wrap: break-word;">${task.notes || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰å†™'}</p>
        <button class="btn btn-danger float-end delete-task" data-task-id="${task.id}">ğŸ—‘</button>
      </div>
    </div>
  `;

  // æ·»åŠ åˆ°ä»»åŠ¡åˆ—è¡¨
  taskList.appendChild(listItem);
}

// åˆ é™¤ä»»åŠ¡çš„å‡½æ•°
function deleteTask(taskId) {
  fetch(`/delete_task/${taskId}`, {
    method: 'DELETE',
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      // ä»é¡µé¢ç§»é™¤ä»»åŠ¡
      const taskItem = document.querySelector(`[data-task-id="${taskId}"]`).closest('.accordion-item');
      if (taskItem) {
        taskItem.remove();  // ä» DOM ä¸­ç§»é™¤ä»»åŠ¡å…ƒç´ 
      }
    } else {
      alert('åˆ é™¤ä»»åŠ¡å¤±è´¥');
    }
  })
  .catch((error) => {
    console.error('Error:', error);
  });
}

// é¡µé¢åŠ è½½æ—¶
document.addEventListener('DOMContentLoaded', function () {
  // åœ¨é¡µé¢åŠ è½½æ—¶æŠ˜å ä»»åŠ¡è¯¦æƒ…éƒ¨åˆ†
  let taskDetails = document.querySelector('#task-details');
  if (taskDetails) {
    let collapseInstance = bootstrap.Collapse.getOrCreateInstance(taskDetails);
    collapseInstance.hide();  // é»˜è®¤æŠ˜å 
  }

  // é¡µé¢åŠ è½½æ—¶è·å–å¹¶æ˜¾ç¤ºä»»åŠ¡
  fetch('/tasks')
    .then(response => response.json())
    .then(tasks => {
      tasks.forEach(displayTask);
    })
    .catch(error => console.error('Error:', error));
});

// ç›‘å¬ Add Task æŒ‰é’®äº‹ä»¶
document.getElementById('add-task').addEventListener('click', function() {
  const taskTitle = document.getElementById('task-title').value.trim();
  const taskNotes = document.getElementById('task-notes').value.trim();
  const taskEmergency = Number(document.querySelector('input[name="task-emergency"]:checked')?.value);
  const taskImportance = Number(document.querySelector('input[name="task-importance"]:checked')?.value);
  const taskDifficulty = Number(document.querySelector('input[name="task-difficulty"]:checked')?.value);
  const taskTime = Number(document.getElementById('task-time').value);
  
  if (!taskTitle) {
    alert("è¯·å¡«å†™ä»»åŠ¡æ ‡é¢˜");
    return;
  }

  // åˆ›å»ºä»»åŠ¡å¯¹è±¡
  const task = {
    title: taskTitle,
    notes: taskNotes,
    emergency: taskEmergency,
    importance: taskImportance,
    difficulty: taskDifficulty,
    time: taskTime
  };
  // ä¿å­˜ä»»åŠ¡åˆ°æœåŠ¡å™¨
  saveTaskToServer(task);

  // // è°ƒç”¨æ˜¾ç¤ºä»»åŠ¡çš„å‡½æ•°
  // displayTask(task);

  // æ¸…ç©ºè¡¨å•
  document.getElementById('task-title').value = '';
  document.getElementById('task-notes').value = '';
  document.getElementById('task-time').value = '15';

  // é‡æ–°è®¾ç½®é€‰ä¸­çš„å•é€‰æŒ‰é’®
  const selectedEmergency = document.querySelector('input[name="task-emergency"]:checked');
  const selectedImportance = document.querySelector('input[name="task-importance"]:checked');
  const selectedDifficulty = document.querySelector('input[name="task-difficulty"]:checked');
  if (selectedEmergency) {
    document.getElementById('emergency-low').checked = true;
  }
  if (selectedImportance) {
    document.getElementById('importance-low').checked = true;
  }
  if (selectedDifficulty) {
    document.getElementById('difficulty-easy').checked = true;
  }

  // æ‰‹åŠ¨è§¦å‘æŠ˜å å¡«å†™ä»»åŠ¡è¯¦æƒ…éƒ¨åˆ†
  let taskDetails = document.querySelector('#task-details');
  if (taskDetails) {
    // è·å–æˆ–åˆ›å»º Collapse å®ä¾‹ï¼Œå¹¶å°†å…¶æŠ˜å 
    let collapseInstance = bootstrap.Collapse.getOrCreateInstance(taskDetails);
    collapseInstance.hide();  // è‡ªåŠ¨æŠ˜å å¡«å†™éƒ¨åˆ†
  }
  });

// ç›‘å¬è¾“å…¥æ¡†çš„keydownäº‹ä»¶
document.getElementById('task-title').addEventListener('keydown', function(event) {
  // æ£€æµ‹æ˜¯å¦æŒ‰ä¸‹äº†Enteré”®ï¼ˆkey code 13ï¼‰
  if (event.key === 'Enter' || event.keyCode === 13) {
    event.preventDefault(); // é˜»æ­¢è¡¨å•çš„é»˜è®¤æäº¤è¡Œä¸º
    document.getElementById('add-task').click(); // è§¦å‘Add TaskæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
  }
});

// ç›‘å¬åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
document.addEventListener('click', function(event) {
  if (event.target.classList.contains('delete-task')) {
    const taskId = event.target.getAttribute('data-task-id');

    // å¼¹å‡ºç¡®è®¤çª—å£
    if (confirm('ä½ ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
      deleteTask(taskId);  // æ‰§è¡Œåˆ é™¤ä»»åŠ¡çš„é€»è¾‘
    }
  }
});

</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Research | Pokémon Tracker</title>
  <!-- 引入Bootswatch: Darkly主题 -->
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/minty/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<!-- =========================================================== -->
<!-- 导航栏 -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">Pokémon Tracker</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarTracking" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Tracking
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarTracking">
            <li><a class="dropdown-item" href="/tracking/research">Research</a></li>
            <li><a class="dropdown-item" href="/tracking/habits">Habits</a></li>
            <li><a class="dropdown-item" href="/tracking/todos">To-Dos</a></li>
          </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/pokedex">Pokédex</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Shops</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- =========================================================== -->
<!-- 主内容区域 -->
<div class="container mt-4">

  <!-- 顶部区域：勋章展示和累计时长 -->
  <div class="container mt-4">
    <h2>Medals</h2>
    <div id="badge-container" class="d-flex justify-content-start flex-wrap">
      <!-- 勋章展示区 -->
    </div>
  </div>
  
  <!-- 展示今日时间 -->
  <div class="container mt-4">
    <h2 class="d-flex">
      <span class="me-4">Today Time:</span>
      <div id="today-research-time"></div>
    </h2>
  </div>
  
  <!-- 计时器区域 -->
  <div class="container mt-4">
    <h2>Timer</h2>
    <div class="d-flex align-items-center">
      <div id="timer-display" class="display-4" style="width: 250px;">00:00:00</div>
      <button class="btn btn-primary ms-3" onclick="startTimer()">Start</button>
      <button class="btn btn-warning ms-3" onclick="pauseTimer()">Pause</button>
      <button class="btn btn-danger ms-3" onclick="stopTimer()">Stop</button>
    </div>
  </div>

  <!-- 手动输入区域 -->
  <div class="container mt-4">
    <h2>Record Time</h2>
    <div class="mb-3 d-flex justify-content-front">
      <div class="d-flex align-items-center">
        <!-- Pick Date -->
        <label for="date-picker" class="form-label me-2" style="white-space: nowrap;">Pick Date</label>
        <input type="date" class="form-control me-4" id="date-picker" style="width: auto;">

        <!-- Input Time -->
        <label for="manual-time-input" class="form-label me-2" style="white-space: nowrap;">Input Time (minute)</label>
        <input type="number me-auto" class="form-control me-4" id="manual-time-input" min="0" placeholder="minutes" style="width: auto;">
      </div>

      <!-- Save Button -->
      <button class="btn btn-primary" onclick="manualTimeEntry()">Save Time</button>
    </div>
  </div>

  <!-- 可视化图表区域 -->
  <div class="container mt-4">
    <h2>Visualization</h2>
    <canvas id="time-chart" class="mb-4" width="400" height="160"></canvas>
  </div>
</div>

<!-- =========================================================== -->
<!-- 分配时间的 Modal -->
<div class="modal fade" id="time-distribution-modal" tabindex="-1" aria-labelledby="time-distribution-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="time-distribution-label">Time Allocation Ratio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Please use the slider to allocate the proportion of time between theoretical and practical tasks:</p>

        <!-- 滑动条 -->
        <label for="theory-practice-slider" class="form-label">Theory (0-100%)</label>
        <input type="range" class="form-range" id="theory-practice-slider" min="0" max="100" value="50">
        <p>Current Allocation: <span id="theory-percentage">50</span>% Theory, <span id="practice-percentage">50</span>% Practice</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirm-distribution-btn">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- =========================================================== -->
<!-- JavaScript逻辑 -->
<!-- 引入Bootstrap的JS组件 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/command.js') }}"></script>
<script>

const commandManager = new CommandManager();
let timerInterval;
let elapsedTime = 0;
let secondsToDistribute = 0;
let dateToRecord;

// ========================================================
// 页面加载时
document.addEventListener('DOMContentLoaded', function () {
  const fetchResearchCommand = new FetchResearchCommand();
  commandManager.executeCommand(fetchResearchCommand);
})

// 计时器开始计时
function startTimer() {
  const startTime = Date.now() - elapsedTime * 1000 - 60000;  // 继续上次计时
  timerInterval = setInterval(() => {
    elapsedTime = Math.floor((Date.now() - startTime) / 1000);  // 以秒为单位
    document.getElementById('timer-display').textContent = formatTime(elapsedTime);  // 更新页面上的计时器
  }, 1000);
}

// 暂停计时
function pauseTimer() {
  clearInterval(timerInterval);
}

// 停止计时并分配时间
function stopTimer() {
  pauseTimer();
  secondsToDistribute = elapsedTime;
  dateToRecord = new Date().toISOString().split('T')[0];  // .toJSON()?
  distributeTime();

  // 重置计时器显示
  elapsedTime = 0;
  document.getElementById('timer-display').textContent = formatTime(0);
}

// 分配时间
function distributeTime() {
  // 显示时间分配滑动条的 Modal
  const slider = document.getElementById('theory-practice-slider');
  const theoryPercentageDisplay = document.getElementById('theory-percentage');
  const practicePercentageDisplay = document.getElementById('practice-percentage');

  slider.value = 50;  // 初始值
  theoryPercentageDisplay.textContent = 50;
  practicePercentageDisplay.textContent = 50;

  // 监听滑动条的变化
  slider.addEventListener('input', function() {
    const practicePercentage = slider.value;
    const theoryPercentage = 100 - practicePercentage;
    theoryPercentageDisplay.textContent = theoryPercentage;
    practicePercentageDisplay.textContent = practicePercentage;
  });

  // 打开 Modal
  const modal = new bootstrap.Modal(document.getElementById('time-distribution-modal'));
  modal.show();

  // 为时间分配的确认按钮注册点击事件
  document.getElementById('confirm-distribution-btn').onclick = function() {
    // 获得两个种类的时间分配
    const slider = document.getElementById('theory-practice-slider');
    const practicePercentage = parseInt(slider.value, 10);
    const theoryPercentage = 100 - practicePercentage;

    let practiceMinutes = Math.floor(secondsToDistribute * (practicePercentage / 6000));
    let theoryMinutes = Math.floor(secondsToDistribute * (theoryPercentage / 6000));

    let researchData = {
      date: dateToRecord,
      theory_time: theoryMinutes,
      practice_time: practiceMinutes,
    };

    // 调用添加 Research 记录的 command
    const addResearchCommand = new AddResearchCommand(researchData);
    commandManager.executeCommand(addResearchCommand);

    // 关闭 Modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('time-distribution-modal'));
    modal.hide();
  };
}

// 格式化时间（将秒数转换为 hh:mm:ss 格式）
function formatTime(totalSeconds) {
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

</script>
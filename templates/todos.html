<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ToDos | PokÃ©mon Tracker</title>
  <!-- å¼•å…¥Bootswatch: Darklyä¸»é¢˜ -->
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/minty/bootstrap.min.css" rel="stylesheet">
  <style>
    .toast {
      background-color: var(--bs-success); /*--bs-success-bg-subtle*/
      color: var(--bs-dark);  /* é»‘è‰²æ–‡å­— */
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);  /* æ·»åŠ é˜´å½± */
      border-radius: 10px;  /* åœ†è§’ */
      width: auto;  /* é€‚å½“çš„å®½åº¦ */
      text-align: center; /* è®©æ–‡æœ¬å±…ä¸­ */
    }
    .toast-header {
      font-size: 1.6em;
    }
    .toast-body {
        padding-top: 20px;
        padding-bottom: 20px;
        padding-left: 120px;  /* å¢åŠ å†…éƒ¨é—´è· */
        padding-right: 120px;  /* å¢åŠ å†…éƒ¨é—´è· */
        font-size: 1.6em;  /* å¢åŠ å­—ä½“å¤§å° */
    }
  </style>
</head>
<body>

<!-- =========================================================== -->
<!-- å¯¼èˆªæ  -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">PokÃ©mon Tracker</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarTracking" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Tracking
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarTracking">
            <li><a class="dropdown-item" href="/tracking/research">Research</a></li>
            <li><a class="dropdown-item" href="/tracking/habits">Habits</a></li>
            <li><a class="dropdown-item" href="/tracking/todos">To-Dos</a></li>
          </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/pokedex">PokÃ©dex</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Shops</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


<!-- =========================================================== -->
<!-- ä¸»å†…å®¹åŒºåŸŸ -->
<div class="container mt-4">
  <h1 class="text-primary mb-4">To-Dos</h1>

  <!-- ä»»åŠ¡è¾“å…¥æ¡† -->
  <form id="todo-form" class="mb-3">
  <!-- </form> -->
    <div class="input-group d-flex align-items-center">
      <input type="text" class="form-control" id="task-title" placeholder="Task title...">
      <button class="btn btn-secondary" type="button" id="toggle-details">
        Toggle Details
      </button>
      <button class="btn btn-success" type="button" id="add-task">Add Task</button>
    </div>
  </form>

  <!-- æ˜¾ç¤ºæœªå®Œæˆçš„ä»»åŠ¡ -->
  <div class="accordion mt-4" id="unfinished-task-list">
    <h2 class="d-flex justify-content-between">
      Unfinished
      <!-- æ’åºæŒ‰é’® -->
      <div class="btn-group" role="group" aria-label="Sorting group">
        <input type="radio" class="btn-check sort-btn" name="unfinished-sort" id="unfinished-sort-btn-created-at" data-sort="created_at" autocomplete="off" checked="">
        <label class="btn btn-outline-light" for="unfinished-sort-btn-created-at">ğŸ“…</label>

        <input type="radio" class="btn-check sort-btn" name="unfinished-sort" id="unfinished-sort-btn-emergency" data-sort="emergency" autocomplete="off">
        <label class="btn btn-outline-light" for="unfinished-sort-btn-emergency">ğŸ”¥</label>

        <input type="radio" class="btn-check sort-btn" name="unfinished-sort" id="unfinished-sort-btn-importance" data-sort="importance" autocomplete="off">
        <label class="btn btn-outline-light" for="unfinished-sort-btn-importance">â­</label>

        <input type="radio" class="btn-check sort-btn" name="unfinished-sort" id="unfinished-sort-btn-difficulty" data-sort="difficulty" autocomplete="off">
        <label class="btn btn-outline-light" for="unfinished-sort-btn-difficulty">ğŸ”®</label>

        <input type="radio" class="btn-check sort-btn" name="unfinished-sort" id="unfinished-sort-btn-time" data-sort="time" autocomplete="off">
        <label class="btn btn-outline-light" for="unfinished-sort-btn-time">â±</label>

        <!-- æ­£åº/å€’åºæŒ‰é’® -->
        <button class="btn btn-outline-light sort-direction" id="unfinished-sort-direction-btn" data-direction="desc">ğŸ”»</button>
      </div>
    </h2>
    <ul class="list-group">
      <!-- æœªå®Œæˆçš„ä»»åŠ¡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
    </ul>
  </div>

  <!-- æ˜¾ç¤ºå·²å®Œæˆçš„ä»»åŠ¡ -->
  <div class="accordion mt-4 mb-5" id="finished-task-list">
    <h2 class="d-flex justify-content-between">
      Finished
      <div class="btn-group" role="group" aria-label="Sorting group">
        <input type="radio" class="btn-check sort-btn" name="finished-sort" id="finished-sort-btn-created-at" data-sort="created_at" autocomplete="off" checked="">
        <label class="btn btn-outline-light" for="finished-sort-btn-created-at">ğŸ“…</label>

        <input type="radio" class="btn-check sort-btn" name="finished-sort" id="finished-sort-btn-emergency" data-sort="emergency" autocomplete="off">
        <label class="btn btn-outline-light" for="finished-sort-btn-emergency">ğŸ”¥</label>

        <input type="radio" class="btn-check sort-btn" name="finished-sort" id="finished-sort-btn-importance" data-sort="importance" autocomplete="off">
        <label class="btn btn-outline-light" for="finished-sort-btn-importance">â­</label>

        <input type="radio" class="btn-check sort-btn" name="finished-sort" id="finished-sort-btn-difficulty" data-sort="difficulty" autocomplete="off">
        <label class="btn btn-outline-light" for="finished-sort-btn-difficulty">ğŸ”®</label>

        <input type="radio" class="btn-check sort-btn" name="finished-sort" id="finished-sort-btn-time" data-sort="time" autocomplete="off">
        <label class="btn btn-outline-light" for="finished-sort-btn-time">â±</label>

        <!-- æ­£åº/å€’åºæŒ‰é’® -->
        <button class="btn btn-outline-light sort-direction" id="finished-sort-direction-btn" data-direction="desc">ğŸ”»</button>
      </div>
    </h2>
    <ul class="list-group">
      <!-- å·²å®Œæˆçš„ä»»åŠ¡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
    </ul>
  </div>
</div>


<!-- ç¡®è®¤åˆ é™¤çš„æ¨¡æ€æ¡† -->
<div class="modal fade" id="modal-delete-confirm" tabindex="-1" aria-labelledby="modal-delete-confirm-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal-delete-confirm-label">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this task?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
      </div>
    </div>
  </div>
</div>


<!-- é€šç”¨ä»»åŠ¡ Modal -->
<div class="modal fade" id="task-modal" tabindex="-1" aria-labelledby="task-modal-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="task-modal-label">New Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="task-form">
          <!-- Title -->
          <div class="mb-3">
            <label for="modal-task-title" class="form-label">Title</label>
            <input type="text" class="form-control" id="modal-task-title" placeholder="Task title...">
          </div>

          <!-- Notes -->
          <div class="mb-3">
            <label for="task-notes" class="form-label">Notes</label>
            <textarea class="form-control" id="task-notes" rows="2" placeholder="ä»»åŠ¡å¤‡æ³¨"></textarea>
          </div>

          <!-- Emergency é€‰æ‹© -->
          <label style="width: 120px" class="me-2">Emergency</label>
          <div class="btn-group my-1" role="group" aria-label="Emergency group">
            <input type="radio" class="btn-check" name="task-emergency" id="emergency-low" autocomplete="off" checked="" value=1>
            <label class="btn btn-outline-danger" for="emergency-low" style="width: 80px;">Low</label>

            <input type="radio" class="btn-check" name="task-emergency" id="emergency-medium" autocomplete="off" value=2>
            <label class="btn btn-outline-danger" for="emergency-medium" style="width: 100px;">Medium</label>

            <input type="radio" class="btn-check" name="task-emergency" id="emergency-high" autocomplete="off" value=3>
            <label class="btn btn-outline-danger" for="emergency-high" style="width: 100px;">High</label>

            <input type="radio" class="btn-check" name="task-emergency" id="emergency-critical" autocomplete="off" value=4>
            <label class="btn btn-outline-danger" for="emergency-critical" style="width: 120px;">Critical</label>
          </div>

          <!-- Importance é€‰æ‹© -->
          <label style="width: 120px" class="me-2">Importance</label>
          <div class="btn-group my-1" role="group" aria-label="Importance group">
            <input type="radio" class="btn-check" name="task-importance" id="importance-low" autocomplete="off" checked="" value=1>
            <label class="btn btn-outline-warning" for="importance-low" style="width: 80px;">Low</label>

            <input type="radio" class="btn-check" name="task-importance" id="importance-medium" autocomplete="off" value=2>
            <label class="btn btn-outline-warning" for="importance-medium" style="width: 100px;">Medium</label>

            <input type="radio" class="btn-check" name="task-importance" id="importance-high" autocomplete="off" value=3>
            <label class="btn btn-outline-warning" for="importance-high" style="width: 100px;">High</label>

            <input type="radio" class="btn-check" name="task-importance" id="importance-critical" autocomplete="off" value=4>
            <label class="btn btn-outline-warning" for="importance-critical" style="width: 120px;">Critical</label>
          </div>

          <!-- Difficulty é€‰æ‹© -->
          <label style="width: 120px" class="me-2">Difficulty</label>
          <div class="btn-group my-1" role="group" aria-label="Difficulty group">
            <input type="radio" class="btn-check" name="task-difficulty" id="difficulty-easy" autocomplete="off" checked="" value=1>
            <label class="btn btn-outline-info" for="difficulty-easy" style="width: 80px;">Easy</label>

            <input type="radio" class="btn-check" name="task-difficulty" id="difficulty-medium" autocomplete="off" value=2>
            <label class="btn btn-outline-info" for="difficulty-medium" style="width: 100px;">Medium</label>

            <input type="radio" class="btn-check" name="task-difficulty" id="difficulty-hard" autocomplete="off" value=3>
            <label class="btn btn-outline-info" for="difficulty-hard" style="width: 100px;">Hard</label>

            <input type="radio" class="btn-check" name="task-difficulty" id="difficulty-very-hard" autocomplete="off" value=4>
            <label class="btn btn-outline-info" for="difficulty-very-hard" style="width: 120px;">Very Hard</label>
          </div>

          <!-- Estimated Time (ä½¿ç”¨é€‰æ‹©æ¡†å®ç°) -->
          <div class="mb-1 d-flex align-items-center">
            <label for="task-time" class="form-label me-2" style="width: 120px">Estimated Time</label>
            <select class="form-select w-auto my-1" id="task-time">
              <option value="5">5 mins</option>
              <option value="15">15 mins</option>
              <option value="30">30 mins</option>
              <option value="60">1 hour</option>
              <option value="120">2 hour</option>
              <option value="240">4 hour</option>
              <option value="480">8 hour</option>
              <option value="960">16 hour</option>
              <option value="1440">24 hour</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="modal-save-btn" class="btn btn-primary">Create</button>
      </div>
    </div>
  </div>
</div>


<!-- æç¤ºä»»åŠ¡å®Œæˆè·å¾—å¾—åˆ°å¥–åŠ±çš„ Toast -->
<div id="task-finish-toast-container" class="position-fixed top-40 start-50 p-3" style="z-index:1050; transform: translateX(-50%) translateY(-50%);">
  <div id="task-finish-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Well Done!</strong>
      <small>Just now</small>
      <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Close">
        <span aria-hidden="true"></span>
      </button>
    </div>
    <div class="toast-body">
      <!-- åœ¨è¿™é‡Œæ˜¾ç¤ºè·å¾—çš„å¥–åŠ± -->
    </div>
  </div>
</div>

<!-- =========================================================== -->
<!-- JavaScripté€»è¾‘ -->
<!-- å¼•å…¥Bootstrapçš„JSç»„ä»¶ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/command.js') }}"></script>
<script>

const commandManager = new CommandManager();

// ========================================================
// æ’åºæ–¹å‘ï¼Œé»˜è®¤ä¸ºé™åº
let unfinishedSortDirection = 'desc';
let finishedSortDirection = 'desc';
// æ’åºå±æ€§ï¼Œé»˜è®¤ä¸º 'created_at'
let unfinishedSortAttribute = 'created_at';
let finishedSortAttribute = 'created_at';
// æ’åºä»»åŠ¡
function sortTasks(listType, attribute, direction) {
  const taskList = document.getElementById(`${listType}-task-list`).querySelector('ul');
  const tasks = Array.from(taskList.children);  // è·å–æ‰€æœ‰ä»»åŠ¡çš„ DOM å…ƒç´ 
  
  tasks.sort((a, b) => {
    let aValue = getTaskValue(a, attribute);
    let bValue = getTaskValue(b, attribute);

    // å¦‚æœä¸»æ’åºå±æ€§ç›¸åŒï¼Œåˆ™è¿›è¡Œæ¬¡çº§æ’åº
    if (aValue === bValue) {
      return secondarySort(a, b, direction);
    }

    return direction === 'desc' ? bValue - aValue : aValue - bValue;
  });

  // æ¸…ç©ºä»»åŠ¡åˆ—è¡¨å¹¶é‡æ–°æŒ‰é¡ºåºæ’å…¥æ’åºåçš„ä»»åŠ¡
  taskList.innerHTML = '';
  tasks.forEach(task => taskList.appendChild(task));
}
// è·å–ä»»åŠ¡çš„å±æ€§å€¼
function getTaskValue(task, attribute) {
  if (attribute === 'created_at') {
    return new Date(task.querySelector('.created-at').textContent.replace('Created:', '')).getTime();
  } else if (attribute === 'emergency') {
    return task.querySelector('.emergency-symbol').textContent.length;  // æ ¹æ®ğŸ”¥æ•°é‡åˆ¤æ–­
  } else if (attribute === 'importance') {
    return task.querySelector('.importance-symbol').textContent.length;  // æ ¹æ®â­æ•°é‡åˆ¤æ–­
  } else if (attribute === 'difficulty') {
    return task.querySelector('.difficulty-symbol').textContent.length;  // æ ¹æ®ğŸ”®æ•°é‡åˆ¤æ–­
  } else if (attribute === 'time') {
    return parseInt(task.querySelector('.accordion-time').textContent);  // é¢„è®¡æ—¶é—´
  }
  return 0;
}
// æ¬¡çº§æ’åºï¼šEmerg > Import > Diffi > Esti Time > Creat At
function secondarySort(a, b, direction) {
  const attributes = ['emergency', 'importance', 'difficulty', 'time', 'created_at'];
  for (const attr of attributes) {
    let aValue = getTaskValue(a, attr);
    let bValue = getTaskValue(b, attr);

    if (aValue !== bValue) {
      return direction === 'desc' ? bValue - aValue : aValue - bValue;
    }
  }
  return 0;  // å¦‚æœå®Œå…¨ç›¸åŒ
}
// ç‚¹å‡»æ’åºæŒ‰é’® -- å±æ€§
document.querySelectorAll('.sort-btn').forEach(button => {
  button.addEventListener('click', function() {
    const listType = this.id.startsWith('unfinished') ? 'unfinished' : 'finished';
    const sortAttribute = this.getAttribute('data-sort');
    
    if (listType === 'unfinished') {
      unfinishedSortAttribute = sortAttribute;
      sortTasks('unfinished', unfinishedSortAttribute, unfinishedSortDirection);
    } else {
      finishedSortAttribute = sortAttribute;
      sortTasks('finished', finishedSortAttribute, finishedSortDirection);
    }
  });
});
// ç‚¹å‡»æ’åºæŒ‰é’® -- æ­£åº/å€’åº
document.querySelectorAll('.sort-direction').forEach(button => {
  button.addEventListener('click', function() {
    const listType = this.id.startsWith('unfinished') ? 'unfinished' : 'finished';
    
    if (listType === 'unfinished') {
      unfinishedSortDirection = unfinishedSortDirection === 'desc' ? 'asc' : 'desc';
      button.textContent = unfinishedSortDirection === 'desc' ? 'ğŸ”»' : 'ğŸ”º';
      sortTasks('unfinished', unfinishedSortAttribute, unfinishedSortDirection);
    } else {
      finishedSortDirection = finishedSortDirection === 'desc' ? 'asc' : 'desc';
      button.textContent = finishedSortDirection === 'desc' ? 'ğŸ”»' : 'ğŸ”º';
      sortTasks('finished', finishedSortAttribute, finishedSortDirection);
    }
  });
});

// ========================================================
// åœ¨ DOM ä¸­æ˜¾ç¤ºä»»åŠ¡
function displayTask(task) {
  listId = task.is_finished ? 'finished-task-list' : 'unfinished-task-list';
  const taskList = document.getElementById(listId).querySelector('ul');
  const listItem = document.createElement('div');
  listItem.classList.add('accordion-item');

  // ä»»åŠ¡åˆ›å»ºæ—¶é—´
  const formattedCreatedAt = formatDate(task.created_at);
  const formattedFinishedAt = task.is_finished ? formatDate(task.finished_at) : '';

  // è·å–Emergency,Importance,Difficultyçš„ç¬¦å·è¡¨ç¤º
  const emergencySymbol = (task.emergency === 1 ? 'ğŸ”¥' :
    task.emergency === 2 ? 'ğŸ”¥ğŸ”¥' :
      task.emergency === 3 ? 'ğŸ”¥ğŸ”¥ğŸ”¥' :
        task.emergency === 4 ? 'ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥' :
          task.emergency);
  const importanceSymbol = (task.importance === 1 ? 'â­' :
    task.importance === 2 ? 'â­â­' :
      task.importance === 3 ? 'â­â­â­' :
        task.importance === 4 ? 'â­â­â­â­' :
          task.importance);
  const difficultySymbol = (task.difficulty === 1 ? 'ğŸ”®' :
    task.difficulty === 2 ? 'ğŸ”®ğŸ”®' :
      task.difficulty === 3 ? 'ğŸ”®ğŸ”®ğŸ”®' :
        task.difficulty === 4 ? 'ğŸ”®ğŸ”®ğŸ”®ğŸ”®' :
          task.difficulty);

  // æŠŠNotesä¸­çš„æ¢è¡Œç¬¦æ›¿æ¢ä¸ºHTMLçš„æ¢è¡Œæ ‡ç­¾
  const formattedNotes = task.notes ? task.notes.replace(/\n/g, '<br>') : '';

  // ä»»åŠ¡æ˜¾ç¤º
  listItem.innerHTML = `
    <h2 class="accordion-header" id="heading-${task.id}">
      <button class="accordion-button collapsed task-item d-flex" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${task.id}" aria-expanded="false" aria-controls="collapse-${task.title}">
        <span class="accordion-title flex-grow-1" style="overflow: hidden; text-overflow: ellipsis;">${task.title}</span>
        <span class="emergency-symbol" style="width: 150px;">${emergencySymbol}</span>
        <span class="importance-symbol" style="width: 150px;">${importanceSymbol}</span>
        <span class="difficulty-symbol" style="width: 150px;">${difficultySymbol}</span>
        <span class="accordion-time" style="width: 100px;">${task.estimated_time}min</span>
      </button>
    </h2>
    <div id="collapse-${task.id}" class="accordion-collapse collapse" aria-labelledby="heading-${task.id}" data-bs-parent="#${listId}">
      <div class="accordion-body">
        <p style="white-space: pre-wrap; word-wrap: break-word;">${formattedNotes || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰å†™'}</p>
        <div class="d-flex justify-content-between align-items-center">
          <small class="created-at me-4 card-footer text-muted">Created:${formattedCreatedAt}</small>
          ${task.is_finished ? `<small class="finished-at me-auto card-footer text-muted">Finished:${formattedFinishedAt}</small>` : ''}
          <div class="d-flex justify-content-end align-items-center">
            ${task.is_finished ? '' : `
            <button class="btn btn-success float-end finish-task px-5 mx-1" data-task-id="${task.id}">âœ”</button>
            <button class="btn btn-info    float-end update-task px-3 mx-1" data-task-id="${task.id}">âœ</button>
            <label class="separate-mark">|</label>
            `}
            <button class="btn btn-danger float-end delete-task px-3 mx-1" data-task-id="${task.id}">ğŸ—‘</button>
          </div>
        </div>
      </div>
    </div>
  `;

  // æ·»åŠ åˆ°ä»»åŠ¡åˆ—è¡¨
  taskList.appendChild(listItem);
}
// åœ¨ DOM ä¸­æ›´æ–°ä»»åŠ¡
function updateTaskInDOM(taskId, taskData) {
  const listItem = document.querySelector(`#heading-${taskId}`);

  if (listItem) {
    // æ›´æ–° Title
    const titleElement = listItem.querySelector('.accordion-title');
    titleElement.textContent = taskData.title;

    // æ›´æ–° Emergency symbol
    const emergencySymbol = taskData.emergency === 1 ? 'ğŸ”¥' :
      taskData.emergency === 2 ? 'ğŸ”¥ğŸ”¥' :
        taskData.emergency === 3 ? 'ğŸ”¥ğŸ”¥ğŸ”¥' :
          taskData.emergency === 4 ? 'ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥' : taskData.emergency;
    listItem.querySelector('.emergency-symbol').textContent = emergencySymbol;

    // æ›´æ–° Importance symbol
    const importanceSymbol = taskData.importance === 1 ? 'â­' :
      taskData.importance === 2 ? 'â­â­' :
        taskData.importance === 3 ? 'â­â­â­' :
          taskData.importance === 4 ? 'â­â­â­â­' : taskData.importance;
    listItem.querySelector('.importance-symbol').textContent = importanceSymbol;

    // æ›´æ–° Difficulty symbol
    const difficultySymbol = taskData.difficulty === 1 ? 'ğŸ”®' :
      taskData.difficulty === 2 ? 'ğŸ”®ğŸ”®' :
        taskData.difficulty === 3 ? 'ğŸ”®ğŸ”®ğŸ”®' :
          taskData.difficulty === 4 ? 'ğŸ”®ğŸ”®ğŸ”®ğŸ”®' : taskData.difficulty;
    listItem.querySelector('.difficulty-symbol').textContent = difficultySymbol;

    // æ›´æ–° Estimated time
    listItem.querySelector('.accordion-time').textContent = `${taskData.estimated_time}min`;

    // æ›´æ–° Notes
    const collapseDiv = document.querySelector(`#collapse-${taskId}`);
    const notesElement = collapseDiv.querySelector('p');
    notesElement.innerHTML = taskData.notes.replace(/\n/g, '<br>');
  }
}
// åœ¨ DOM ä¸­æŠŠä»»åŠ¡ç§»åŠ¨åˆ°å·²å®Œæˆåˆ—è¡¨
function finishTaskInDom(taskId, finishedAt) {
  const taskItem = document.querySelector(`[data-task-id="${taskId}"]`).closest('.accordion-item');
  if (taskItem) {
    // 1. åˆ é™¤ update-task, finish-task æŒ‰é’®
    const updateButton = taskItem.querySelector('.update-task');
    const finishButton = taskItem.querySelector('.finish-task');
    const separateMark = taskItem.querySelector('.separate-mark');

    if (updateButton) {
      updateButton.remove();
    }
    if (finishButton) {
      finishButton.remove();
    }
    if (separateMark) {
      separateMark.remove();
    }

    const collapseDiv = taskItem.querySelector('.accordion-collapse');
    if (collapseDiv) {
      // å¦‚æœå·²ç»æœ‰å®ä¾‹ï¼Œå…ˆé”€æ¯æ—§çš„ Collapse å®ä¾‹
      const existingInstance = bootstrap.Collapse.getInstance(collapseDiv);
      if (existingInstance) {
        existingInstance.dispose();  // é”€æ¯æ—§çš„å®ä¾‹
      }

      // æ›´æ–° data-bs-parent å±æ€§ï¼Œç¡®ä¿æŠ˜å è¡Œä¸ºæ­£å¸¸
      collapseDiv.setAttribute('data-bs-parent', '#finished-task-list');

      // å¢åŠ  Finished time
      const formattedFinishedAt = formatDate(finishedAt);
      collapseDiv.querySelector('small').insertAdjacentHTML('afterend',
        `<small class="me-auto card-footer text-muted">Finished:${formattedFinishedAt}</small>`)

      // å°†ä»»åŠ¡ä» Unfinished åˆ—è¡¨ç§»åŠ¨åˆ° Finished åˆ—è¡¨
      taskItem.remove();
      document.getElementById('finished-task-list').querySelector('ul').appendChild(taskItem);

      // é‡æ–°åˆå§‹åŒ– Bootstrap Collapse è¡Œä¸º
      let newCollapseInstance = new bootstrap.Collapse(collapseDiv, {
        toggle: false  // ç¡®ä¿ä»»åŠ¡åˆå§‹æ—¶ä¸ºæŠ˜å çŠ¶æ€
      });
      // æ‰‹åŠ¨æŠ˜å æ–°å®Œæˆçš„ä»»åŠ¡
      newCollapseInstance.hide();
    }
  }
}
// é‡ç½®è¡¨å•å†…å®¹
function resetTaskInput() {
  document.getElementById('task-title').value = '';
  if (document.getElementById('task-modal')) {
    document.getElementById('modal-task-title').value = '';
    document.getElementById('task-notes').value = '';
    document.getElementById('task-time').value = '15';
    document.getElementById('emergency-low').checked = true;
    document.getElementById('importance-low').checked = true;
    document.getElementById('difficulty-easy').checked = true;
  }
}
// æ ¼å¼åŒ–æ—¶é—´æˆ³ yyyy/mm/dd-hh:mm
function formatDate(timestamp) {
  const date = new Date(timestamp);
  const year = String(date.getFullYear());  // è·å–åä¸¤ä½å¹´ä»½
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hour = String(date.getHours()).padStart(2, '0');
  const minute = String(date.getMinutes()).padStart(2, '0');
  const second = String(date.getSeconds()).padStart(2, '0');
  return `${year}/${month}/${day}-${hour}:${minute}:${second}`;
}

// ========================================================
// é¡µé¢åŠ è½½æ—¶
document.addEventListener('DOMContentLoaded', function () {
  const fetchTasksCommand = new FetchTasksCommand();
  commandManager.executeCommand(fetchTasksCommand);
})

// ç‚¹å‡»å¿«æ·åˆ›å»ºä»»åŠ¡ Add Task
document.getElementById('add-task').addEventListener('click', function() {
  // å”¯ä¸€éœ€è¦æä¾›çš„æ˜¯ title
  const taskTitle = document.getElementById('task-title').value.trim();
  if (!taskTitle) {
    alert("è¯·å¡«å†™ä»»åŠ¡æ ‡é¢˜");
    return;
  }

  const task = {
    title: taskTitle,
    notes: '',
    emergency: 1,
    importance: 1,
    difficulty: 1,
    is_finished: false,
    created_at: new Date().toISOString(),
    estimated_time: 5,
  };
  const addTaskCommand = new AddTaskCommand(task);
  commandManager.executeCommand(addTaskCommand);
})

// Enter å¿«æ·åˆ›å»ºä»»åŠ¡
document.getElementById('task-title').addEventListener('keydown', function(event) {
  if (event.key === 'Enter' || event.keyCode === 13) {
    event.preventDefault();  // é˜»æ­¢è¡¨å•çš„é»˜è®¤æäº¤è¡Œä¸º
    document.getElementById('add-task').click();  // Toggle [Add Task] click
  }
})

// ç‚¹å‡»å±•å¼€è¯¦æƒ…åˆ›å»ºä»»åŠ¡
document.getElementById('toggle-details').addEventListener('click', function() {
  // æ›´æ–° Modal çš„æ ‡é¢˜å’ŒæŒ‰é’®
  document.getElementById('task-modal-label').textContent = 'New Task';
  document.getElementById('modal-save-btn').textContent = 'Create';

  // æ˜¾ç¤º Modal
  const taskModal = new bootstrap.Modal(document.getElementById('task-modal'));
  taskModal.show();

  // è®¾ç½®ä¿å­˜æŒ‰é’®çš„åŠŸèƒ½ä¸ºåˆ›å»ºä»»åŠ¡
  document.getElementById('modal-save-btn').onclick = function() {
    const taskTitle = document.getElementById('modal-task-title').value.trim();
    if (!taskTitle) {
      alert("è¯·å¡«å†™ä»»åŠ¡æ ‡é¢˜");
      return;
    }
    const taskNotes = document.getElementById('task-notes').value.trim();
    const taskEmergency = Number(document.querySelector('input[name="task-emergency"]:checked').value);
    const taskImportance = Number(document.querySelector('input[name="task-importance"]:checked').value);
    const taskDifficulty = Number(document.querySelector('input[name="task-difficulty"]:checked').value);
    const taskEstimatedTime = Number(document.getElementById('task-time').value);

    const task = {
      title: taskTitle,
      notes: taskNotes,
      emergency: taskEmergency,
      importance: taskImportance,
      difficulty: taskDifficulty,
      estimated_time: taskEstimatedTime,
      is_finished: false,
      created_at: new Date().toISOString(),
    };

    const addTaskCommand = new AddTaskCommand(task);
    commandManager.executeCommand(addTaskCommand);

    // éšè— Modal
    const taskModal = bootstrap.Modal.getInstance(document.getElementById('task-modal'));
    taskModal.hide();
  };
})

// ç‚¹å‡»åˆ é™¤ä»»åŠ¡
document.addEventListener('click', function(event) {
  if (event.target.classList.contains('delete-task')) {
    // è·å¾—ä»»åŠ¡çš„ id æ³¨æ„éœ€è¦è½¬æ¢ç±»å‹å¦åˆ™æ— æ³•æœ‰æ•ˆåˆ é™¤ IndexedDB çš„æ•°æ®
    const taskId = Number(event.target.getAttribute('data-task-id'));

    const confirmModal = new bootstrap.Modal(document.getElementById('modal-delete-confirm'));
    confirmModal.show();

    document.getElementById('confirm-delete-btn').onclick = function() {
      const deleteTaskCommand = new DeleteTaskCommand(taskId);
      commandManager.executeCommand(deleteTaskCommand);
      confirmModal.hide();
    }
  }
});

// ç‚¹å‡»ä¿®æ”¹ä»»åŠ¡
document.addEventListener('click', function(event) {
  if (event.target.classList.contains('update-task')) {
    // è·å¾—ä»»åŠ¡çš„ id æ³¨æ„éœ€è¦è½¬æ¢ç±»å‹æ‰èƒ½ç”¨äº IndexedDB
    const taskId = Number(event.target.getAttribute('data-task-id'));
    
    // æ‰¾åˆ°ä»»åŠ¡ DOM å…ƒç´ å¹¶ä»ä¸­è·å–ä¿¡æ¯
    const listItem = document.querySelector(`#heading-${taskId}`);
    if (listItem) {
      // æ›´æ–° Modal çš„æ ‡é¢˜å’ŒæŒ‰é’®
      document.getElementById('task-modal-label').textContent = 'Edit Task';
      document.getElementById('modal-save-btn').textContent = 'Save';

      // è·å– Title
      const taskTitle = listItem.querySelector('.accordion-title').textContent;

      // è·å– Emergency, Importance, Difficulty
      const taskEmergencySymbol = listItem.querySelector('.emergency-symbol').textContent;
      const taskImportanceSymbol = listItem.querySelector('.importance-symbol').textContent;
      const taskDifficultySymbol = listItem.querySelector('.difficulty-symbol').textContent;
      const taskEmergency = [...taskEmergencySymbol].length
      const taskImportance = [...taskImportanceSymbol].length
      const taskDifficulty = [...taskDifficultySymbol].length

      // è·å– Estimated Time
      const taskEstimatedTime = Number(listItem.querySelector('.accordion-time').textContent.slice(0, -3));  // å»æ‰ min

      // è·å– Notes
      const collapseDiv = listItem.nextElementSibling;
      const taskNotes = collapseDiv.querySelector('p').textContent;

      // å¡«å……è¡¨å•å†…å®¹
      document.getElementById('modal-task-title').value = taskTitle;
      document.getElementById('task-notes').value = taskNotes;
      document.querySelector(`input[name="task-emergency"][value="${taskEmergency}"]`).checked = true;
      document.querySelector(`input[name="task-importance"][value="${taskImportance}"]`).checked = true;
      document.querySelector(`input[name="task-difficulty"][value="${taskDifficulty}"]`).checked = true;
      document.getElementById('task-time').value = taskEstimatedTime;

      // æ˜¾ç¤º Modal
      const taskModal = new bootstrap.Modal(document.getElementById('task-modal'));
      taskModal.show();

      // ç‚¹å‡»ä¿å­˜æŒ‰é’®åˆ™æ›´æ–°ä»»åŠ¡ä¿¡æ¯
      document.getElementById('modal-save-btn').onclick = function() {
        const taskData = {
          'title': document.getElementById('modal-task-title').value.trim(),
          'notes': document.getElementById('task-notes').value.trim(),
          'emergency': Number(document.querySelector('input[name="task-emergency"]:checked').value),
          'importance': Number(document.querySelector('input[name="task-importance"]:checked').value),
          'difficulty': Number(document.querySelector('input[name="task-difficulty"]:checked').value),
          'estimated_time': Number(document.getElementById('task-time').value),
        };

        // æ›´æ–°ä»»åŠ¡ä¿¡æ¯
        const updateTaskCommand = new UpdateTaskCommand(taskId, taskData);
        commandManager.executeCommand(updateTaskCommand);

        // éšè— Modal
        taskModal.hide();
      };
    }

  }
})

// ç‚¹å‡»å®Œæˆä»»åŠ¡
document.addEventListener('click', function(event) {
  if (event.target.classList.contains('finish-task')) {
    // è·å¾—ä»»åŠ¡çš„ id æ³¨æ„éœ€è¦è½¬æ¢ç±»å‹
    const taskId = Number(event.target.getAttribute('data-task-id'));
    const finishedAt = new Date().toISOString();

    const finishTaskCommand = new FinishTaskCommand(taskId, finishedAt);
    commandManager.executeCommand(finishTaskCommand);

    // è·å¾—ä»»åŠ¡çš„å…¶ä»–æ•°æ®, ä»¥è®¡ç®—å¥–åŠ±
    const listItem = document.querySelector(`#heading-${taskId}`);
    if (listItem) {
      // è·å– Emergency, Importance, Difficulty
      const taskEmergencySymbol = listItem.querySelector('.emergency-symbol').textContent;
      const taskImportanceSymbol = listItem.querySelector('.importance-symbol').textContent;
      const taskDifficultySymbol = listItem.querySelector('.difficulty-symbol').textContent;
      const taskEmergency = [...taskEmergencySymbol].length
      const taskImportance = [...taskImportanceSymbol].length
      const taskDifficulty = [...taskDifficultySymbol].length

      // è·å– Estimated Time
      const taskEstimatedTime = Number(listItem.querySelector('.accordion-time').textContent.slice(0, -3));  // å»æ‰ min

      // è®¡ç®—é‡‘å¸å’Œå…¶ä»–å¥–åŠ±
      rewards = calculateRewards(taskEmergency, taskImportance, taskDifficulty, taskEstimatedTime);
      // å¼¹å‡ºçª—å£æ˜¾ç¤ºè·å¾—çš„ç‰©å“
      const coin = rewards[0].delta;
      const candy = rewards[1].delta;
      const toastText = (candy > 0 ? `Candy + ${candy}<br>` : '') + `Coins + ${coin}`;
      const toastElement = document.getElementById('task-finish-toast');
      toastElement.querySelector('.toast-body').innerHTML = toastText;
      const toast = new bootstrap.Toast(toastElement);
      toast.show();
      // æ·»åŠ ç‰©å“
      console.log("rewards", rewards);
      rewards.forEach(item => {
        if (item.delta > 0) {
          const addItemCommand = new AddItemCommand(item.id, item.delta);
          commandManager.executeCommand(addItemCommand);
        }
      });
    }
  }
});


// ========================================================
// è®¡ç®—å®Œæˆä»»åŠ¡çš„å¥–åŠ±
function calculateRewards(emergency, importance, difficulty, minutes) {
  const timeCoeff = Math.pow(minutes, 1/3);  // æ—¶é—´[5, 1440] --å¯¹åº”--> [1.7, 11.3]
  const taskWeight = Math.sqrt((importance - 0.5) * (difficulty - 0.5));  // [0.5, 3.5]

  let coin = randomNumber(2, 5);  // åˆå§‹é‡‘å¸å¥–åŠ±éšæœºåœ¨ [2, 5] èŒƒå›´ä¸­
  coin += taskWeight * timeCoeff;
  coin = Math.floor(coin);
  
  let candy = 0;
  if (difficulty >= 4) { candy += 1; }
  if (importance >= 4) { candy += 1; }
  let candyBonus = 0;
  for (i = 0; i < timeCoeff; i++) {
    if (randomNumber(0, 20) < taskWeight) { candyBonus += 1; }
  }
  candyBonus = Math.min(candyBonus, 2);
  candy += candyBonus;

  return [
    { id: 1,  delta: coin },  // é‡‘å¸
    { id: 21, delta: candy }  // ç¥å¥‡ç³–æœ
  ];
}
function randomInteger(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}
function randomNumber(min, max) {
  return Math.random() * (max - min) + min;
}
</script>

</body>